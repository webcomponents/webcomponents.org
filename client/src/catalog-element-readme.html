<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="custom-element-demo.html">

<dom-module id="catalog-element-readme">
  <!-- TODO: Support for external stylesheets is deprecated in favor of style modules. -->
  <link rel="import" type="css" href="../bower_components/github-markdown-css/github-markdown.css">
  <template>
    <style>
      /** Readme.md override */
      .markdown-body .anchor {
        margin-left: 0;
        padding-right: 0;
      }

      article.markdown-body > h2:first-of-type, article.markdown-body > h1:first-of-type {
        display: none;
      }

    </style>

    <article id="contents" class="markdown-body"></article>

  </template>

  <script>
    Polymer({

      is: 'catalog-element-readme',

      properties: {
        readme: String,

        baseUrls: Object
      },

      observers: [
        'readmeChanged(readme)'
      ],

      readmeChanged: function(readme) {
        if (!readme)
          return;

        this.$.contents.innerHTML = readme;
        // Only scope once so inline demos don't have conflicting styles.
        this.scopeSubtree(this.$.contents, false);

        var codeBlocks = [].slice.call(Polymer.dom(this.root).querySelectorAll('pre'));

        // Find and replace all inline demos.
        while (codeBlocks.length) {
          var block = codeBlocks.shift();
          var demoMatch = block.textContent.match(/<custom-element-demo[^]*?>[^]*<\/custom-element-demo>/);
          if (!demoMatch)
            continue;

          var dummyParse = document.createElement('template');
          dummyParse.innerHTML = block.textContent;
          var dummyDemoElement = dummyParse.content.firstChild;
          var demoElement = document.createElement('custom-element-demo');
          demoElement.setAttribute('width', dummyDemoElement.getAttribute('width'));
          demoElement.setAttribute('height', dummyDemoElement.getAttribute('height'));
          demoElement.baseUrl = this.baseUrls.userContent;

          // Swap elements out.
          var parent = block.parentElement;
          parent.parentElement.replaceChild(demoElement, parent);

          // Find and set code.
          var code = dummyDemoElement.firstElementChild.innerHTML;
          // Strip empty new line & one level of indentation.
          code = code.replace(/^\n/, "").replace(/^ {4}/gm, '').replace(/\n\s*$/, '');
          var nextBlockRegex = /<next-code-block><\/next-code-block>/;
          var snippet = '';
          if (code.match(nextBlockRegex) && codeBlocks.length) {
            var nextBlock = codeBlocks.shift();
            snippet = nextBlock.textContent;
            if (nextBlock.parentNode)
              nextBlock.parentNode.removeChild(nextBlock);
          }

          demoElement.data = this.data;
          demoElement.snippet = snippet;
          demoElement.code = code;
        }
      },

    });
  </script>
</dom-module>
