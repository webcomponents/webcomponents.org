<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-layout/helpers/helpers.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">

<link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro" rel="stylesheet">

<link rel="import" href="lazy-block.html">

<dom-module id="catalog-app">
  <template>
    <style>
      :host {
        display: block;
        max-width: 980px;
        margin: 0 auto;
        font-family: 'Source Sans Pro', sans-serif;
        font-size: 16px;
        line-height: 24px;
        padding-top: 80px;
        --theme-accent-1: #6dc38f;
        --theme-font: 'Source Sans Pro', sans-serif;
        --monospace-font: 'Source Code Pro', monospace;
        --theme-blue: #18b4d9;
        --theme-blue-dark: #1f9bb9;

        /* Based on Atom/one-dark-syntax theme https://github.com/atom/one-dark-syntax */
        --syntax-hue:          220;
        --syntax-saturation:   13%;
        --syntax-brightness:   18%;

        /* Monochrome */
        --mono-1: hsl(var(--syntax-hue), 14%, 71%); /* default text */
        --mono-2: hsl(var(--syntax-hue),  9%, 55%);
        --mono-3: hsl(var(--syntax-hue), 10%, 40%);

        /* Colors */
        --hue-1:   hsl(187, 47%, 55%); /* cyan */
        --hue-2:   hsl(207, 82%, 66%); /* blue */
        --hue-3:   hsl(286, 60%, 67%); /* purple */
        --hue-4:   hsl( 95, 38%, 62%); /* green */

        --hue-5:   hsl(355, 65%, 65%); /* red 1 */
        --hue-5-2: hsl(  5, 48%, 51%); /* red 2 */

        --hue-6:   hsl( 29, 54%, 61%); /* orange 1 */
        --hue-6-2: hsl( 39, 67%, 69%); /* orange 2 */

        /* Base colors*/
        --syntax-fg:     var(--mono-1);
        --syntax-bg:     hsl(var(--syntax-hue), var(--syntax-saturation), var(--syntax-brightness));
        --syntax-selection: hsl(var(--syntax-hue), var(--syntax-saturation), 28%);
        --syntax-corrected-selection: hsl(var(--syntax-hue), 7%, 62%);
        --syntax-accent: hsl(var(--syntax-hue), 100%, 66% );
        --syntax-gutter: hsl(var(--syntax-hue), 14%, 45%);
        --syntax-guide: hsla(var(--syntax-hue), 14%, 71%, 0.85);
      }

      #progress {
        position: absolute;
        top: 64px;
        left: 0px;
        width: 100vw;
        --paper-progress-active-color: var(--theme-blue);
        --paper-progress-indeterminate-cycle-duration: 3s;
        --paper-progress-transition-transition-delay: 250ms;
        height: 5px;
      }

      app-header {
        @apply(--layout-fixed-top);
        z-index: 1;
        background-color: var(--theme-accent-1);
        color: white;
      }

      app-toolbar {
        max-width: 980px;
        margin: 0 auto;
      }

      #search-box {
        box-sizing: border-box;
        width: 500px;
        height: 40px;
        font-family: var(--theme-font);
        font-size: 16px;
        padding: 12px;
        border: 1px solid #ededed;
        border-radius: 4px;
      }

      iron-pages.loading > *.iron-selected {
        display: block;
        opacity: 0;
      }

      iron-pages:not(.loading) > *.iron-selected {
        display: block;
        animation: fade-in 250ms cubic-bezier(0, 0, 0.2, 1);
      }

      @keyframes fade-in {
        0% { opacity: 0; }
        100% { opacity: 1; }
      }

    </style>

    <catalog-analytics key="[[analyticsKey()]]"></catalog-analytics>

    <app-location route="{{route}}"></app-location>
    <app-route
      route="{{route}}"
      pattern="/:page"
      data="{{routeData}}"
      tail="{{subroute}}"
      query-params="{{queryParams}}"></app-route>

    <lazy-block id="block"></lazy-block>

    <search-focus id="search-focus" base-urls="[[baseUrls(queryParams)]]"></search-focus>

    <app-header role="navigation" reveals>
      <app-toolbar id="toolbar">
        <input id="search-box" placeholder="Search webcomponents.org" on-click="_loadSearch"></input>
      </app-toolbar>
    </app-header>

    <paper-progress id="progress" indeterminate></paper-progress>

    <iron-pages id="pages" selected="[[page]]" attr-for-selected="name" selected-attribute="visible" on-loading="_updateLoading" on-loaded="_updateLoading">
      <catalog-home name="home" base-urls="[[baseUrls(queryParams)]]"></catalog-home>
      <catalog-author name="author" base-urls="[[baseUrls(queryParams)]]" route="[[subroute]]"></catalog-author>
      <catalog-collection name="collection" base-urls="[[baseUrls(queryParams)]]" route="[[subroute]]"></catalog-collection>
      <catalog-element name="element" route="{{subroute}}" base-urls="[[baseUrls(queryParams)]]"></catalog-element>
      <catalog-preview-integration name="preview-integration" query-params="{{queryParams}}" base-urls="[[baseUrls(queryParams)]]"></catalog-preview-integration>
      <catalog-preview name="preview" base-urls="[[baseUrls(queryParams)]]"></catalog-preview>
      <catalog-publish name="publish" base-urls="[[baseUrls(queryParams)]]"></catalog-publish>
      <catalog-error name="error" id="error"></catalog-error>
    </iron-pages>

  </template>

  <script>
    Polymer({

      is: 'catalog-app',

      properties: {

        page: {
          type: String,
          reflectToAttribute: true,
          observer: '_pageChanged'
        }
      },

      listeners: {
        error: '_handleError',
      },

      observers: [
        '_routePageChanged(routeData.page, subroute)'
      ],

      created: function() {
        if (window.performance && performance.mark)
          performance.mark('catalog-app.created');
        this.removeAttribute('unresolved');
      },

      _setLoading: function() {
        this.$.pages.classList.add('loading');
        this.$.progress.removeAttribute('hidden');
      },

      _clearLoading: function() {
        this.$.pages.classList.remove('loading');
        this.$.progress.setAttribute('hidden', '');
      },

      _updateLoading: function() {
        if (!this.$.pages.selectedItem)
          return;
        if (this.$.pages.selectedItem.loading === true)
          this._setLoading();
        if (this.$.pages.selectedItem.loading === false)
          this._clearLoading();
      },

      _pageReady: function() {
        if (this.$.pages.selectedItem && this.$.pages.selectedItem.loading !== true)
          this._clearLoading();
        if (this._lazyResourcesLoaded)
          return;
        this._lazyResourcesLoaded = true;
        this.$.block.unblock();
      },

      _routePageChanged: function(page) {
        if (page != this.page)
          Polymer.AppLayout.scroll({top: 0, behavior: 'silent'});
        if (page == '') {
          page = 'home';
        }
        if (page == 'preview' && this.subroute.path) {
          page = 'element';
        }
        this.page = page;
      },

      _pageChanged: function(page) {
        if (page) {
          this._setLoading();
          this.importHref(
            this.resolveUrl('catalog-' + page + '.html'), this._pageReady, null, true);
        }
      },

      isProduction: function() {
        return window.location.hostname.indexOf('webcomponents.org') != -1;
      },

      analyticsKey: function() {
        return this.isProduction() ? 'UA-82313441-1' : 'UA-82326223-1';
      },

      baseUrls: function(queryParams) {
        var isLocalhost = window.location.hostname == 'localhost';
        var result = {api: ''};

        if (isLocalhost)
          result.api = 'https://beta.webcomponents.org';

        if (isLocalhost || this.isProduction()) {
          result.userContent = 'https://user-content-dot-custom-elements.appspot.com';
        } else {
          result.userContent = 'https://user-content-dot-custom-elements-staging.appspot.com';
        }
        if (queryParams.instance) {
          result.api = 'https://' + queryParams.instance;
          result.userContent = 'https://user-content-dot-' + queryParams.instance;
        }
        return result;
      },

      _handleError: function(event) {
        this.page = 'error';
        this.$.error.error = event.detail;
      },

      _loadSearch: function() {
        this.importHref(this.resolveUrl('search-focus.html'), function() {
          var offsetLeft = this.$['search-box'].offsetLeft + this.$.toolbar.offsetLeft;
          this.$['search-focus'].open(offsetLeft, this.$['search-box'].offsetTop);
        });
      },

    });
  </script>
</dom-module>
