<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-layout/helpers/helpers.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">

<link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro" rel="stylesheet">

<dom-module id="catalog-app">
  <template>
    <style>
      :host {
        display: block;
        max-width: 980px;
        margin: 0 auto;
        font-family: 'Source Sans Pro', sans-serif;
        font-size: 16px;
        line-height: 22px;
        padding-top: 80px;
        --theme-accent-1: #6dc38f;
        --theme-font: 'Source Sans Pro', sans-serif;
        --monospace-font: 'Source Code Pro', monospace;
        --theme-blue: #18b4d9;
        --theme-blue-dark: #1f9bb9;
      }

      app-header {
        @apply(--layout-fixed-top);
        z-index: 1;
        background-color: var(--theme-accent-1);
        color: white;
      }
    </style>

    <catalog-analytics key="[[analyticsKey()]]"></catalog-analytics>

    <app-location route="{{route}}"></app-location>
    <app-route
      route="{{route}}"
      pattern="/:page"
      data="{{routeData}}"
      tail="{{subroute}}"
      query-params="{{queryParams}}"></app-route>

    <app-header role="navigation" reveals>
      <app-toolbar>
        <div>elements</div>
      </app-toolbar>
    </app-header>

    <iron-pages selected="[[page]]" attr-for-selected="name" selected-attribute="visible">
      <catalog-author name="author" base-urls="[[baseUrls(queryParams)]]" route="[[subroute]]"></catalog-author>
      <catalog-collection name="collection" base-urls="[[baseUrls(queryParams)]]" route="[[subroute]]"></catalog-collection>
      <catalog-element name="element" route="{{subroute}}" base-urls="[[baseUrls(queryParams)]]"></catalog-element>
      <catalog-search name="search" route="{{subroute}}" base-urls="[[baseUrls(queryParams)]]"></catalog-search>
      <catalog-preview-integration name="preview-integration" query-params="{{queryParams}}" base-urls="[[baseUrls(queryParams)]]"></catalog-preview-integration>
      <catalog-preview name="preview" base-urls="[[baseUrls(queryParams)]]"></catalog-preview>
      <catalog-error name="error" id="error"></catalog-error>
    </iron-pages>


  </template>

  <script>
    Polymer({

      is: 'catalog-app',

      properties: {

        page: {
          type: String,
          reflectToAttribute: true,
          observer: '_pageChanged'
        }

      },

      listeners: {
        error: '_handleError',
      },

      observers: [
        '_routePageChanged(routeData.page)'
      ],

      created: function() {
        if (window.performance && performance.mark)
          performance.mark('catalog-app.created');
        this.removeAttribute('unresolved');
      },

      _routePageChanged: function(page) {
        if (page != this.page)
          Polymer.AppLayout.scroll({top: 0, behavior: 'silent'});
        this.page = page || 'search';
      },

      _pageChanged: function(page) {
        if (page != null) {
          this.importHref(
            this.resolveUrl('catalog-' + page + '.html'), null, null, true);
        }
      },

      isStaging: function() {
        return window.location.hostname.indexOf('custom-elements-staging') != -1 ||
            window.location.hostname.indexOf('australischertreibhund.com') != -1;
      },

      analyticsKey: function() {
        var useStagingKey = window.location.hostname == 'localhost' || this.isStaging();
        return useStagingKey ? 'UA-82326223-1' : 'UA-82313441-1';
      },

      baseUrls: function(queryParams) {
        var isLocalhost = window.location.hostname == 'localhost';
        var result = {api: '', userContent: 'https://user-content-dot-' + window.location.hostname};
        if (isLocalhost) {
          result.api = 'https://custom-elements.appspot.com';
          result.userContent = 'https://user-content-dot-custom-elements.appspot.com';
        } else if (this.isStaging()) {
          result.userContent = 'https://user-content-dot-custom-elements-staging.appspot.com';
        }
        if (queryParams.instance) {
          result.api = 'https://' + queryParams.instance;
          result.userContent = 'https://user-content-dot-' + queryParams.instance;
        }
        return result;
      },

      _handleError: function(event) {
        var status;
        var message;
        if (event.detail) {
          status = event.detail.status;
          message = event.detail.message;
        }
        this.page = 'error';
        this.$.error.status = status;
        this.$.error.message = message;
      },

    });
  </script>
</dom-module>
