<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-doc-viewer/iron-doc-viewer.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">

<link rel="import" href="activity-graph.html">
<link rel="import" href="catalog-styles.html">
<link rel="import" href="catalog-element-readme.html">
<link rel="import" href="contributors-list.html">
<link rel="import" href="lazy-block.html">

<dom-module id="catalog-element">
  <template>
    <style include="catalog-styles"></style>
    <style>
      /* Header */
      #header {
        color: hsl(0, 0%, 50%);
        margin-bottom: 30px;
      }

      #repo-version {
        margin-left: 6px;
        font-size: 24px;
        line-height: 45px;
      }

      #repo-desc {
        font-size: 24px;
        line-height: 24px;
        margin: 0 0 8px 0;
      }

      #repo-author {
        line-height: 40px;
        vertical-align: top;
        display: flex;
      }

      #header .avatar {
        width: 40px;
        height: 40px;
        border-radius: 4px;
        margin-right: 8px;
      }

      /* Repo info */

      #info-header {
        border-radius: 4px 4px 0 0;
        display: flex;
        padding: 12px 16px;
      }

      #info-header[body-collapsed] {
        border-bottom: none;
      }

      #info-download {
        padding-left: 16px;
        border-left: 1px solid #ededed;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
      }

      #info-stats {
        display: flex;
        justify-content: space-between;
        padding-right: 16px;
      }

      #info-stats div {
        display: flex;
        align-items: center;
      }

      #info-stats svg {
        width: 24px;
        height: 24px;
        margin-right: 5px;
      }

      .octicon-star {
        color: #ffe200;
      }

      .octicon-repo-forked {
        color: #8342bd;
      }

      .octicon-eye {
        color: var(--theme-accent-1);
      }

      .octicon-issue-opened {
        color: #939ca1;
      }

      #info-view-github {
        flex: 0 0 220px !important;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 16px;
      }

      #info-contributors {
        flex: 0 0 270px !important;
      }

      #info-dependencies {
        line-height: 32px;
      }

      #info-dependencies .owner {
        color: hsl(0, 0%, 50%);
      }

      #info-dependencies .repo {
        font-weight: bold;
      }

      #info-body {
        display: flex;
        padding: 30px 0;
        flex-wrap: wrap;
      }

      #info-body[body-collapsed] {
        display: none;
      }

      #info-body > div {
        margin: 0 16px;
      }

      #info-footer {
        border-radius: 0 0 4px 4px;
        text-transform: uppercase;
        font-weight: bold;
        font-size: 14px;
        height: 44px;
        display: flex;
        justify-content: space-between;
      }

      #info-footer a {
        margin-right: 16px;
      }

      #info-tags {
        padding: 8px 12px;
      }

      #expand-collapse {
        padding: 8px 12px;
        height: 100%;
        border-left: 1px solid #ededed;
        text-align: center;
      }

      #expand-collapse svg {
        width: 16px;
        height: 16px;
      }

      #info-body > *, #info-header > * {
        flex: 1 0;
      }

      /* Sidebar */
      #sidebar-nav {
        margin-bottom: 32px !important;
      }

      #sidebar-nav a {
        padding: 16px 20px;
        font-weight: bold;
        font-size: 14px;
        line-height: 14px;
        border-top: 1px solid #ededed;
        display: flex;
        justify-content: space-between;
      }

      #sidebar-nav a span {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 185px;
      }

      #sidebar-nav a:first-child {
        font-size: 18px;
        line-height: 21px;
        border: none;
      }

      .sidebar a.demo-link {
        background: hsl(0, 0%, 98%);
      }

      .sidebar a.demo-link:after {
        content: 'demo';
        text-transform: uppercase;
        font-weight: normal;
        float: right;
        color: #c2c2c2;
      }

      .collection .header {
        padding: 16px;
        height: 160px;
      }

      .collection .header h1 {
        margin: 0 0 16px;
      }

      .collection .header div {
        color: hsl(0, 0%, 50%);
        overflow: hidden;
        max-height: 90px;
      }

      .collection .footer {
        border-top: 1px solid #ededed;
        padding: 16px;
        display: flex;
        align-items: center;
      }

      .collection .footer .avatar {
        margin-right: 16px;
      }

      /* Demo frame */

      #demo-dialog {
        width: calc(100vw - 100px);
        height: calc(100vh - 100px);
        margin: 0;
        padding: 0;
      }

      #demo-frame {
        width: 100%;
        height: 100%;
        border: none;
        margin: 0;
        padding: 0;
      }

      #demo-spinner {
        position: fixed;
        left: 50%;
        top: 50%;
        z-index: 1000;
        width: 60px;
        height: 60px;
        margin-left: -30px;
        margin-top: -30px;
        --paper-spinner-stroke-width: 4px;
      }

      #close-dialog {
        width: 40px;
        height: 40px;
        position: absolute;
        left: -16px;
        top: -16px;
        background: white;
        border: 1px solid #ededed;
        border-radius: 50%;
        padding: 0;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14),
                  0 1px 5px 0 rgba(0, 0, 0, 0.12),
                  0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }

      #close-dialog svg {
        height: 20px;
        width: 20px;
        color: hsl(0, 0%, 40%);
      }

      @media (max-width: 500px), (max-height: 500px) {
        #container {
          padding: 16px;
        }

        #info-body, #info-download, #info-view-github, #info-footer, #info-header h3 {
          display: none;
        }

        #demo-dialog {
          width: calc(100vw - 50px);
          height: calc(100vh - 50px);
        }
      }
    </style>

    <app-location route="{{routeLocation}}"></app-location>

    <iron-ajax
      id="metaAjax"
      loading="{{metaLoading}}"
      url="[[baseUrls.api]]/api/meta/[[owner]]/[[repo]][[versionRoute]]"
      handle-as="json"
      last-response="{{data}}"
      on-response="_metaResponse"
      on-error="_metaError"></iron-ajax>

    <iron-ajax
      id="docsAjax"
      loading="{{docsLoading}}"
      url="[[baseUrls.api]]/api/docs/[[owner]]/[[repo]][[versionRoute]]"
      handle-as="json"
      last-response="{{docs}}"
      on-response="_handleResponse"></iron-ajax>

    <iron-ajax
      id="collectionsAjax"
      url="[[baseUrls.api]]/api/collections/[[owner]]/[[repo]][[versionRoute]]"
      handle-as="json"
      last-response="{{collections}}"></iron-ajax>

    <lazy-block condition="[[!metaLoading]]"></lazy-block>
    <lazy-block condition="[[docs]]"></lazy-block>

    <div id="container" class="loader" loading$="[[metaLoading]]">

      <!-- Header -->
      <div id="header">
        <h1 class="page-title">[[repo]]</h1>
        <span id="repo-version">[[data.version]]</span>
        <h2 class="page-subtitle">[[data.description]]</h2>
        <div id="repo-author">
          <img class="avatar" src="[[data.avatar_url]]&s=40">
          <span>by <a href="/author/[[owner]]">[[owner]]</a></span>
        </div>
      </div>

      <!-- Repo info -->
      <div id="info-header" class="box" body-collapsed$="[[_infoBodyCollapsed]]">
        <div>
          <h3>GitHub Statistics</h3>
          <div id="info-stats">
            <div>
              <svg viewBox="0 0 100 100" class="octicon octicon-star">
               <use xlink:href="/sprite.octicons.svg#star"></use>
              </svg>
              [[data.stars]]
            </div>
            <div>
              <svg viewBox="0 0 100 100" class="octicon octicon-repo-forked">
               <use xlink:href="/sprite.octicons.svg#repo-forked"></use>
              </svg>
              [[data.forks]]
            </div>
            <div>
              <svg viewBox="0 0 100 100" class="octicon octicon-eye">
               <use xlink:href="/sprite.octicons.svg#eye"></use>
              </svg>
              [[data.subscribers]]
            </div>
            <div>
              <svg viewBox="0 0 100 100" class="octicon octicon-issue-opened">
               <use xlink:href="/sprite.octicons.svg#issue-opened"></use>
              </svg>
              [[data.open_issues]]
            </div>
          </div>
        </div>
        <div id="info-download">
          <h3>Download</h3>
          $ bower install --save [[owner]]/[[repo]]</div>
        <div id="info-view-github" class="box">
          <a href="https://github.com/[[owner]]/[[repo]]" target="_blank">View source on Github</a>
       </div>
      </div>

      <template is="dom-if" if="[[!metaLoading]]">
        <div id="info-body" body-collapsed$="[[_infoBodyCollapsed]]">
          <div id="info-dependencies">
            <h3>Dependencies</h3>
            <template is="dom-repeat" items="[[_dependencies()]]">
              <div class="dependency">
                <a href="/element/[[item.owner]]/[[item.repo]]">
                  <span class="owner">[[item.owner]]/</span><span class="repo">[[item.repo]]</span>
                </a>
                <span>[[item.version]]</span>
              </div>
            </template>
          </div>
          <div id="info-graph">
            <h3>Latest commit [[_timeSinceString(data.updated_at)]] ago</h3>
            <activity-graph activity="[[data.activity]]"></activity-graph>
          </div>
          <div id="info-contributors">
            <h3>[[data.contributors.length]] contributors</h3>
            <contributors-list contributors="[[data.contributors]]"></contributors-list>
          </div>
        </div>
      </template>

      <div id="info-footer" class="box">
        <div id="info-tags">
          <template is="dom-repeat" items="[[data.bower.keywords]]">
            <a href="/search/bower_keywords:[[item]]">[[item]]</a>
          </template>
        </div>
        <div id="expand-collapse" on-tap="_toggleExpand" body-collapsed$="[[_infoBodyCollapsed]]">
          <template is="dom-if" if="[[_infoBodyCollapsed]]">
            <svg viewBox="0 0 100 100" class="octicon octicon-plus">
             <use xlink:href="/sprite.octicons.svg#plus"></use>
            </svg>
          </template>
          <template is="dom-if" if="[[!_infoBodyCollapsed]]">
            <svg viewBox="0 0 100 100" class="octicon octicon-dash">
             <use xlink:href="/sprite.octicons.svg#dash"></use>
            </svg>
          </template>
        </div>
      </div>

      <div class="body">
        <!-- Repository contents sidebar -->
        <div class="sidebar">
          <h1>Repository contents</h1>

          <div id="sidebar-nav" class="box loader" loading$="[[docsLoading]]">
            <a href="/element/[[owner]]/[[repo]][[versionRoute]]">[[repo]]</a>

            <template is="dom-repeat" items="[[bundledElements]]" as="element">
              <a href="/element/[[owner]]/[[repo]][[versionRoute]]/[[element.is]]" on-tap="_scrollToMain">[[_docLabel(element.is)]]</a>

              <template is="dom-repeat" items=[[element.demos]] as="demo">
                <a class="demo-link" href="/element/[[owner]]/[[repo]]/[[data.version]]/demo/[[demo.path]]" on-tap="_demoClicked"><span>[[demo.desc]]</span></a>
              </template>
            </template>

            <template is="dom-repeat" items="[[bundledBehaviors]]" as="behavior">
              <a href="/element/[[owner]]/[[repo]]/[[data.version]]/[[behavior.is]]" on-tap="_scrollToMain">[[behavior.is]]</a>
            </template>
          </div>

          <div class="loader" loading$="[[_or(docsLoading, collectionsLoading)]]">
            <template is="dom-if" if="[[collections.length]]">
              <h3>[[collections.length]] collections</h3>

              <template is="dom-repeat" items="[[collections]]">
                <div class="box collection">
                  <a href="/collection/[[item.owner]]/[[item.repo]]">
                    <div class="header">
                      <h1>[[item.repo]]</h1>
                      <div>[[item.description]]</div>
                    </div>
                  </a>
                  <div class="footer">
                    <img class="avatar" src="[[item.avatar_url]]&s=30" title="[[item.owner]]">
                    <span>Collected by <a href="/author/[[item.owner]]">[[item.owner]]</a></span>
                  </div>
                </div>
              </template>
            </template>
          </div>
        </div>

        <!-- Main content pane -->
        <div id="main-content" class="main-content">
          <h1 hidden="[[subElement]]">README.md</h1>
          <template is="dom-if" if="[[data]]">
            <catalog-element-readme data="[[data]]" readme="[[data.readme]]" base-urls="[[baseUrls]]" hidden="[[subElement]]"></catalog-element-readme>
          </template>

          <div hidden="[[!subElement]]">
            <h2 title>[[subElement]]</h2>
            <iron-doc-viewer descriptor="[[descriptor]]"></iron-doc-viewer>
          </div>
        </div>
      </div>
    </div>

    <paper-spinner-lite id="demo-spinner"></paper-spinner-lite>
    <paper-dialog id="demo-dialog" with-backdrop on-iron-overlay-canceled="_demoCanceled">
      <div id="close-dialog" on-tap="_cancelDemo">
        <svg viewBox="0 0 100 100" class="octicon octicon-x">
          <use xlink:href="/sprite.octicons.svg#x"></use>
        </svg>
      </div>
      <iframe id="demo-frame" on-load="_demoLoaded"></iframe>
    </paper-dialog>


  </template>

  <script>
    Polymer({

      is: 'catalog-element',

      properties: {
        visible: Boolean,

        route: String,

        baseUrls: Object
      },

      observers: [
        '_routeChanged(route.path, route.prefix, visible)',
        'onload(metaLoading)'
      ],

      ready: function() {
        this._loaded = true;
        this._infoBodyCollapsed = false;
        if (this.route)
          this._routeChanged(this.route.path, this.route.prefix, this.visible);
      },

      _elements: function() {
        if (!this.docs)
          return [];
        return Object.keys(this.docs.elementsByTagName).map(function(elem) {
          return this.docs.elementsByTagName[elem];
        }.bind(this));
      },

      _behaviors: function() {
        if (!this.docs)
          return [];
        return Object.keys(this.docs.behaviorsByName).map(function(elem) {
          return this.docs.behaviorsByName[elem];
        }.bind(this));
      },

      _demos: function() {
        if (!this.docs || !this.bundledElements)
          return [];

        // Dedupe demos since elements can point to the same demo.
        var demosByPath = {};
        this.bundledElements.forEach(function(elem) {
          elem.demos.forEach(function(demo) {
            demosByPath[demo.path] = demo;
          });
        });

        return Object.keys(demosByPath).map(function(demoPath) {
          return demosByPath[demoPath];
        });
      },

      onload: function(metaLoading) {
        if (!this.visible || !metaLoading)
          return;

        this.data = null;
        delete this.descriptor;
        this.bundledElements = [];
        this.bundledBehaviors = [];
        this.collections = null;
        this.docs = null;
      },

      _splitRoute: function() {
        this.versionRoute = '';
        this.subElement = null;
        this.demo = null;

        var split = this.route.path.split('/');
        split.shift(); // Skip first /
        this.owner = split.shift();
        this.repo = split.shift();

        if (split.length && split[0].indexOf('.') != -1)
          this.versionRoute = '/' + split.shift();
        else if (split.length && split[0].match(/[0-9a-f]{20,}/))
          this.versionRoute = '/' + split.shift();

        if (split.length && split[0].indexOf('demo') != -1) {
          split.shift();
          this.demo = split.join('/');
          split = [];
        }

        if (split.length)
          this.subElement = split.shift();
      },

      _routeChanged: function(path, prefix, visible) {
        if (!visible || !this._loaded || prefix !== '/element')
          return;

        this._splitRoute();
        document.title = this.owner + '/' + this.repo;

        // Generate requests
        if (!this._cachedData || this._cachedData !== this.repo) {
          this.$.metaAjax.generateRequest();
          this.$.docsAjax.generateRequest();
          this.$.collectionsAjax.generateRequest();
          this._cachedData = this.repo;
        } else {
          this._updateDescriptor();
        }

        // Trigger / hide demo UI.
        if (this.demo) {
          this._showDemo();
        } else {
          this.$['demo-dialog'].close();
          this.$['demo-frame'].src = 'about:blank';
        }
      },

      _demoClicked: function() {
        this.pathBeforeDemo = this.route.path;
      },

      _showDemo: function() {
        var demoUrl = this.baseUrls.userContent + '/' + this.owner + '/' + this.repo + this.versionRoute + '/' + this.repo + '/' + this.demo;
        this.$['demo-frame'].src = demoUrl;
        this.$['demo-dialog'].open();
        this.$['demo-spinner'].setAttribute('active', '');
      },

      _demoLoaded: function() {
        this.$['demo-spinner'].removeAttribute('active');
      },

      _cancelDemo: function() {
        this.$['demo-dialog'].cancel();
      },

      _demoCanceled: function() {
        this.$['demo-spinner'].removeAttribute('active');
        this.$['demo-frame'].src = 'about:blank';
        var path = this.pathBeforeDemo;
        this.pathBeforeDemo = null;
        if (!path) {
          path = this.owner + '/' + this.repo + this.versionRoute;
        }
        this.set('route.path', path);
      },

      _metaResponse: function() {
        // TODO: handle status != ready
        this._handleResponse();
      },

      _metaError: function(event, error) {
        if (error.request.status == 404)
          this.fire('error', {status: 404, message: 'Could not find element'});
      },

      _handleResponse: function() {
        if (this.data)
          document.title = this.data.owner + '/' + this.data.repo;
        this._updateDescriptor();
      },

      _updateDescriptor: function() {
        if (!this.docs)
          return;
        this.bundledElements = this._elements();
        this.bundledBehaviors = this._behaviors();
        this.bundledDemos = this._demos();
        this.descriptor = this.docs.elementsByTagName[this.subElement] || this.docs.behaviorsByName[this.subElement];
      },

      _navigateToSearch: function() {
        this.set('routeLocation.path', '/search');
      },

      _dependencies: function() {
        if (!this.data || !this.data.bower || !this.data.bower.dependencies)
          return [];
        var results = [];
        var names = Object.keys(this.data.bower.dependencies);
        var i;
        for (i = 0; i < names.length; i++) {
          var name = names[i];
          var parts = this.data.bower.dependencies[name].split(/[\/#]/g);
          results.push({
            owner: parts[0],
            repo: parts[1],
            version: parts[2],
          });
        }
        return results;
      },

      _timeSinceString: function(time) {
        var ms = Date.now() - Date.parse(time);
        if (ms < 1000 * 60)
          return "less than a minute";
        if (ms < 1000 * 60 * 60)
          return "less than an hour";
        if (ms < 1000 * 60 * 60 * 24)
          return Math.round(ms / 1000 / 60 / 60) + " hours";
        if (ms < 1000 * 60 * 60 * 24 * 30)
          return Math.round(ms / 1000 / 60 / 60 / 24) + " days";
        return Math.round(ms / 1000 / 60 / 60 / 24 / 365 * 12) + " months";
      },

      _docLabel: function(element) {
        return this.bundledElements.length == 1 ? 'Element API' : element;
      },

      _toggleExpand: function() {
        this._infoBodyCollapsed = !this._infoBodyCollapsed;
      },

      _or: function(a, b) {
        return a || b;
      },

      _scrollToMain: function() {
        var top = this.$['main-content'].offsetTop - 16;
        Polymer.AppLayout.scroll({top: top, behavior: 'smooth'});
      },

    });
  </script>
</dom-module>
