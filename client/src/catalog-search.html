<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">

<link rel="import" href="catalog-item.html">

<dom-module id="catalog-search">
  <template>
    <style>
    :host {
      height: 100vh;
    }

    /* Search list */

    input[type=search] {
      -webkit-appearance: none;
      height: 46px;
      line-height: 46px;
      margin: 16px 0;
      padding-left: 50px;
      padding-right: 16px;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-family: 'Roboto', 'Noto', sans-serif;
      font-weight: 400;
      width: 100%;
    }

    input[type=search]:focus {
      outline: 0;
      background-color: #ECEFF1;
      border-color: #cfd8dc;
    }

    input[type=search] {
      border: 1px solid #dedede;
      border-radius: 3px;
    }

    </style>

    <app-route
      route="{{route}}"
      pattern="/:query"
      data="{{routeData}}"></app-route>

    <iron-ajax
      auto
      id="ajax"
      loading="{{loading}}"
      url="[[baseUrls.api]]/api/search/[[routeData.query]]"
      handle-as="json"
      last-response="{{_data}}"
      on-request="_handleRequest"
      on-response="_handleResponse"
      debounce-duration="300"
      params="[[_requestParams]]"></iron-ajax>

      <input type="search" id="search" placeholder="Search" on-keyup="_onSearchKeyUp" on-focus="_onSearchFocus">

      <iron-scroll-threshold on-lower-threshold="_loadMoreResults" id="threshold" lower-threshold="200">
        <iron-list id="resultsList" items="[[_results]]" as="item" scroll-target="threshold">
          <template>
            <catalog-item data="[[item]]" tabindex$="[[tabIndex]]"></catalog-item>
          </template>
        </iron-list>
      </iron-scroll-threshold>
  </template>

  <script>
    Polymer({

      is: 'catalog-search',

      properties: {
        visible: {
          type: Boolean,
          observer: '_visiblityChanged'
        },

        route: {
          type: String,
          notifies: true
        },

        baseUrls: Object,

        _results: Array,

        _data: Array,

        _requestParams: Object,
      },

      observers: [
        '_onNavigation(visible, route.prefix)',
        '_queryChanged(route.query)',
      ],

      ready: function() {
        // TODO: Should listen to request/response events on iron-ajax and show a spinner
        this.$.search.value = this.routeData.query || "";
        this.$.search.focus();
        this.$.activeRequests = null;
      },

      _onNavigation: function(visible, prefix) {
        if (!visible)
          return;

        document.title = 'Search';

        // Return to the same search results as before.
        if (prefix == '/search' && !this.route.path) {
          this.$.search.focus();
          // TODO: this causes back button to require 2 backs to go back.
          this.set('route.path', this.$.search.value);
        }
      },

      _visiblityChanged: function(visible) {
        if (visible)
          this.$.ajax.setAttribute('auto', '');
        else
          this.$.ajax.removeAttribute('auto');
      },

      _onSearchKeyUp: function() {
        this.set('route.path', this.$.search.value);
      },

      _onSearchFocus: function() {
        this.$.search.select();
      },

      _queryChanged: function(query) {
        if (!this._latestQuery || this._latestQuery != query)
          this._requestParams = {offset: 0};
        this._latestQuery = query;
        this._results = [];
      },

      _handleRequest: function(event) {
        if (!this.routeData.query)
          event.detail.request.abort();
      },

      _handleResponse: function(event) {
        var response = event.detail.response;
        if (!response || !response.results || !response.results.length)
          return;

        var scrollTop = this.$.threshold.scrollTop;
        this._results = this._results.concat(response.results);
        this.$.threshold.scroll(0, scrollTop);
        this.$.threshold.clearTriggers();
        this.$.resultsList.fire('iron-resize');
      },

      _loadMoreResults: function() {
        if (!this._results)
          return;

        this.set('_requestParams.offset', this._results.length);
      },

    });
  </script>
</dom-module>
